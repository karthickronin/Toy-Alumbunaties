{% extends 'crm/base.html' %}

{% block title %}Tasks{% endblock %}
{% block page_title %}Task Management{% endblock %}
{% block page_subtitle %}Organize and track your tasks{% endblock %}

{% block header_actions %}
<a href="#task-modal" class="btn primary-color waves-effect waves-light modal-trigger">
    <i class="material-icons left">add_task</i>New Task
</a>
{% endblock %}

{% block content %}
<!-- Task Stats -->
<div class="row">
    <div class="col s12 m3">
        <div class="metric-card" style="background: linear-gradient(135deg, #2196f3, #64b5f6); padding: 24px; text-align: center;">
            <i class="material-icons metric-icon">assignment</i>
            <div class="metric-value">{{ tasks.paginator.count|default:0 }}</div>
            <div class="metric-label">Total Tasks</div>
        </div>
    </div>
    <div class="col s12 m3">
        <div class="metric-card" style="background: linear-gradient(135deg, #ff9800, #ffb74d); padding: 24px; text-align: center;">
            <i class="material-icons metric-icon">pending</i>
            <div class="metric-value">
                {% with pending_count=tasks|length %}
                    {% for task in tasks %}
                        {% if task.status == 'pending' %}{{ forloop.counter0|add:1 }}{% endif %}
                    {% endfor %}
                {% endwith %}
            </div>
            <div class="metric-label">Pending</div>
        </div>
    </div>
    <div class="col s12 m3">
        <div class="metric-card" style="background: linear-gradient(135deg, #4caf50, #81c784); padding: 24px; text-align: center;">
            <i class="material-icons metric-icon">trending_up</i>
            <div class="metric-value">
                {% with progress_count=tasks|length %}
                    {% for task in tasks %}
                        {% if task.status == 'in_progress' %}{{ forloop.counter0|add:1 }}{% endif %}
                    {% endfor %}
                {% endwith %}
            </div>
            <div class="metric-label">In Progress</div>
        </div>
    </div>
    <div class="col s12 m3">
        <div class="metric-card" style="background: linear-gradient(135deg, #9c27b0, #ba68c8); padding: 24px; text-align: center;">
            <i class="material-icons metric-icon">flag</i>
            <div class="metric-value">
                {% with urgent_count=tasks|length %}
                    {% for task in tasks %}
                        {% if task.priority == 'urgent' %}{{ forloop.counter0|add:1 }}{% endif %}
                    {% endfor %}
                {% endwith %}
            </div>
            <div class="metric-label">Urgent</div>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="card">
    <div class="card-content">
        <span class="card-title">
            <i class="material-icons left">filter_list</i>Filter Tasks
        </span>
        <form method="get">
            <div class="row">
                <div class="input-field col s12 m4">
                    <select name="status">
                        <option value="">All Status</option>
                        {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                    <label>Status</label>
                </div>
                <div class="input-field col s12 m4">
                    <select name="priority">
                        <option value="">All Priorities</option>
                        {% for value, label in priority_choices %}
                            <option value="{{ value }}" {% if priority_filter == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                    <label>Priority</label>
                </div>
                <div class="col s12 m4">
                    <button type="submit" class="btn primary-color waves-effect waves-light" style="margin-top: 20px; width: 100%;">
                        <i class="material-icons left">filter_list</i>Apply Filter
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Task List -->
<div class="card">
    <div class="card-content">
        <span class="card-title">
            <i class="material-icons left">assignment</i>Task List
        </span>
        
        {% if tasks %}
            <div class="row">
                {% for task in tasks %}
                <div class="col s12 m6 l4">
                    <div class="card hoverable task-card">
                        <div class="card-content">
                            <div class="row valign-wrapper" style="margin-bottom: 8px;">
                                <div class="col s8">
                                    <span class="card-title" style="font-size: 1.2rem;">{{ task.title }}</span>
                                </div>
                                <div class="col s4 right-align">
                                    <i class="material-icons priority-{{ task.priority }} tiny">flag</i>
                                </div>
                            </div>
                            
                            {% if task.description %}
                            <p class="grey-text">{{ task.description|truncatewords:15 }}</p>
                            {% endif %}
                            
                            {% if task.customer %}
                            <div class="row valign-wrapper" style="margin-bottom: 8px;">
                                <div class="col s2">
                                    <div class="avatar-sm">
                                        {{ task.customer.first_name.0|upper }}{{ task.customer.last_name.0|upper }}
                                    </div>
                                </div>
                                <div class="col s10">
                                    <small class="grey-text">{{ task.customer.full_name }}</small>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="row" style="margin-bottom: 8px;">
                                <div class="col s6">
                                    <span class="status-badge status-{{ task.status }}">
                                        {{ task.get_status_display }}
                                    </span>
                                </div>
                                <div class="col s6 right-align">
                                    <span class="chip priority-{{ task.priority }}">
                                        {{ task.get_priority_display }}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="row" style="margin-bottom: 0;">
                                <div class="col s6">
                                    <small class="grey-text">
                                        <i class="material-icons tiny">schedule</i>
                                        {{ task.due_date|date:"M d, Y" }}
                                    </small>
                                </div>
                                <div class="col s6 right-align">
                                    <small class="grey-text">
                                        <i class="material-icons tiny">person</i>
                                        {{ task.assigned_to.first_name }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="card-action">
                            <a href="#!" class="primary-text" onclick="updateTaskStatus({{ task.id }}, 'completed')">
                                {% if task.status == 'completed' %}
                                    <i class="material-icons left tiny">check_circle</i>Completed
                                {% else %}
                                    <i class="material-icons left tiny">check</i>Mark Complete
                                {% endif %}
                            </a>
                            <a href="#!" class="grey-text" onclick="editTask({{ task.id }})">
                                <i class="material-icons left tiny">edit</i>Edit
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="material-icons">assignment_turned_in</i>
                <h5>No tasks found</h5>
                <p>
                    {% if status_filter or priority_filter %}
                        Try adjusting your filter criteria
                    {% else %}
                        Create your first task to get started
                    {% endif %}
                </p>
                <a href="#task-modal" class="btn-large primary-color waves-effect waves-light modal-trigger">
                    <i class="material-icons left">add_task</i>New Task
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Pagination -->
{% if tasks.has_other_pages %}
<div class="center-align">
    <ul class="pagination">
        {% if tasks.has_previous %}
            <li class="waves-effect">
                <a href="?page={{ tasks.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}">
                    <i class="material-icons">chevron_left</i>
                </a>
            </li>
        {% endif %}
        
        {% for num in tasks.paginator.page_range %}
            {% if tasks.number == num %}
                <li class="active primary-color">
                    <span>{{ num }}</span>
                </li>
            {% elif num > tasks.number|add:'-3' and num < tasks.number|add:'3' %}
                <li class="waves-effect">
                    <a href="?page={{ num }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if tasks.has_next %}
            <li class="waves-effect">
                <a href="?page={{ tasks.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}">
                    <i class="material-icons">chevron_right</i>
                </a>
            </li>
        {% endif %}
    </ul>
</div>
{% endif %}

<!-- New Task Modal -->
<div id="task-modal" class="modal modal-fixed-footer">
    <div class="modal-content">
        <h4><i class="material-icons left">add_task</i>New Task</h4>
        <form id="task-form">
            {% csrf_token %}
            <div class="row">
                <div class="input-field col s12">
                    <i class="material-icons prefix">title</i>
                    <input id="task_title" name="title" type="text" class="validate" required>
                    <label for="task_title">Task Title *</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <i class="material-icons prefix">description</i>
                    <textarea id="task_description" name="description" class="materialize-textarea"></textarea>
                    <label for="task_description">Description</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12 m6">
                    <select name="priority" required>
                        <option value="" disabled selected>Choose Priority</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                    <label>Priority *</label>
                </div>
                <div class="input-field col s12 m6">
                    <input id="due_date" name="due_date" type="date" class="validate" required>
                    <label for="due_date">Due Date *</label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-red btn-flat">Cancel</a>
        <a href="#!" class="waves-effect waves-green btn primary-color" onclick="submitTask()">Create Task</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateTaskStatus(taskId, status) {
    // This would typically make an AJAX call to update the task status
    M.toast({html: 'Task status updated!', classes: 'green'});
    // Reload page to reflect changes
    setTimeout(() => location.reload(), 1000);
}

function editTask(taskId) {
    // This would open an edit modal or redirect to edit page
    M.toast({html: 'Edit functionality coming soon!', classes: 'blue'});
}

function submitTask() {
    const form = document.getElementById('task-form');
    const formData = new FormData(form);
    
    // Basic validation
    const title = formData.get('title');
    const priority = formData.get('priority');
    const dueDate = formData.get('due_date');
    
    if (!title || !priority || !dueDate) {
        M.toast({html: 'Please fill in all required fields', classes: 'red'});
        return;
    }
    
    // This would typically make an AJAX call to create the task
    M.toast({html: 'Task created successfully!', classes: 'green'});
    
    // Close modal and reload page
    const modal = M.Modal.getInstance(document.getElementById('task-modal'));
    modal.close();
    
    setTimeout(() => location.reload(), 1000);
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals
    var modalElems = document.querySelectorAll('.modal');
    M.Modal.init(modalElems);
    
    // Initialize select elements
    var selectElems = document.querySelectorAll('select');
    M.FormSelect.init(selectElems);
    
    // Initialize textareas
    var textareaElems = document.querySelectorAll('textarea');
    M.CharacterCounter.init(textareaElems);
    
    // Set minimum date for due date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('due_date').setAttribute('min', today);
});
</script>

<style>
.task-card {
    transition: all 0.3s ease;
}

.task-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
}

.task-card .card-title {
    line-height: 1.3;
}

.priority-urgent {
    color: #e91e63 !important;
}

.priority-high {
    color: #f44336 !important;
}

.priority-medium {
    color: #ff9800 !important;
}

.priority-low {
    color: #4caf50 !important;
}
</style>
{% endblock %}