{% extends 'crm/base.html' %}

{% block title %}{{ title }}{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block header_actions %}
<a href="{% url 'crm:booking_list' %}" class="btn grey waves-effect waves-light">
    <i class="material-icons left">arrow_back</i>Back to Bookings
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12 l10 offset-l1">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">event_available</i>{{ title }}
                </span>
                
                {% if customer %}
                <!-- Customer Info -->
                <div class="card-panel blue lighten-5">
                    <div class="row valign-wrapper" style="margin-bottom: 0;">
                        <div class="col s2">
                            <div class="avatar">
                                {{ customer.first_name.0|upper }}{{ customer.last_name.0|upper }}
                            </div>
                        </div>
                        <div class="col s10">
                            <h6 style="margin: 0;">{{ customer.full_name }}</h6>
                            <p style="margin: 0;" class="grey-text">
                                <i class="material-icons tiny">email</i> {{ customer.email }} &nbsp;&nbsp;
                                <i class="material-icons tiny">phone</i> {{ customer.phone }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Event Details -->
                    <div class="section">
                        <h6 class="primary-text">
                            <i class="material-icons left">event</i>Event Details
                        </h6>
                        <div class="divider" style="margin-bottom: 24px;"></div>
                        
                        {% if not customer %}
                        <div class="row">
                            <div class="input-field col s12">
                                <select name="customer" required>
                                    <option value="" disabled selected>Choose Customer</option>
                                    <!-- This would be populated with customers from the database -->
                                </select>
                                <label>Customer *</label>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="input-field col s12 m6">
                                <i class="material-icons prefix">event</i>
                                <input id="event_date" name="event_date" type="date" class="validate" required>
                                <label for="event_date">Event Date *</label>
                            </div>
                            <div class="input-field col s12 m6">
                                <i class="material-icons prefix">schedule</i>
                                <input id="event_time" name="event_time" type="time" class="validate" required>
                                <label for="event_time">Event Time *</label>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="input-field col s12 m6">
                                <i class="material-icons prefix">category</i>
                                <select name="event_type" required>
                                    <option value="" disabled selected>Choose Event Type</option>
                                    <option value="birthday">Birthday Party</option>
                                    <option value="school">School Event</option>
                                    <option value="corporate">Corporate Family Day</option>
                                    <option value="festival">Festival Celebration</option>
                                    <option value="other">Other Kids Event</option>
                                </select>
                                <label>Event Type *</label>
                            </div>
                            <div class="input-field col s12 m6">
                                <i class="material-icons prefix">card_giftcard</i>
                                <select name="package" required onchange="updatePrice()">
                                    <option value="" disabled selected>Choose Package</option>
                                    <option value="silver" data-price="5000">Silver Package - ₹5,000</option>
                                    <option value="gold" data-price="6000">Gold Package - ₹6,000</option>
                                    <option value="diamond" data-price="7000">Diamond Package - ₹7,000</option>
                                </select>
                                <label>Package *</label>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="input-field col s12">
                                <i class="material-icons prefix">location_on</i>
                                <textarea id="venue_address" name="venue_address" class="materialize-textarea" required></textarea>
                                <label for="venue_address">Venue Address *</label>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="input-field col s12 m6">
                                <i class="material-icons prefix">people</i>
                                <input id="number_of_children" name="number_of_children" type="number" min="1" value="10" required>
                                <label for="number_of_children">Number of Children *</label>
                            </div>
                            <div class="input-field col s12 m6">
                                <i class="material-icons prefix">child_care</i>
                                <input id="child_age_group" name="child_age_group" type="text" value="3-12 years">
                                <label for="child_age_group">Child Age Group</label>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="input-field col s12">
                                <i class="material-icons prefix">note</i>
                                <textarea id="special_requests" name="special_requests" class="materialize-textarea"></textarea>
                                <label for="special_requests">Special Requests</label>
                                <span class="helper-text">Any special requirements or requests for the event</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pricing -->
                    <div class="section">
                        <h6 class="primary-text">
                            <i class="material-icons left">attach_money</i>Pricing
                        </h6>
                        <div class="divider" style="margin-bottom: 24px;"></div>
                        
                        <div class="row">
                            <div class="input-field col s12 m4">
                                <i class="material-icons prefix">money</i>
                                <input id="base_price" name="base_price" type="number" step="0.01" required readonly>
                                <label for="base_price">Base Price *</label>
                            </div>
                            <div class="input-field col s12 m4">
                                <input id="additional_charges" name="additional_charges" type="number" step="0.01" value="0">
                                <label for="additional_charges">Additional Charges</label>
                            </div>
                            <div class="input-field col s12 m4">
                                <input id="discount" name="discount" type="number" step="0.01" value="0">
                                <label for="discount">Discount</label>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="input-field col s12 m6">
                                <i class="material-icons prefix">payment</i>
                                <input id="advance_paid" name="advance_paid" type="number" step="0.01" value="0">
                                <label for="advance_paid">Advance Paid</label>
                            </div>
                            <div class="col s12 m6">
                                <div class="card-panel center-align">
                                    <h6>Total Amount</h6>
                                    <h4 id="total_amount" class="primary-text">₹0</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="section">
                        <div class="row">
                            <div class="col s12 center-align">
                                <a href="{% url 'crm:booking_list' %}" class="btn-large grey waves-effect waves-light">
                                    <i class="material-icons left">cancel</i>Cancel
                                </a>
                                <button type="submit" class="btn-large primary-color waves-effect waves-light" style="margin-left: 16px;">
                                    <i class="material-icons left">save</i>Create Booking
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updatePrice() {
    const packageSelect = document.querySelector('select[name="package"]');
    const selectedOption = packageSelect.options[packageSelect.selectedIndex];
    const price = selectedOption.getAttribute('data-price');
    
    if (price) {
        document.getElementById('base_price').value = price;
        M.updateTextFields();
        calculateTotal();
    }
}

function calculateTotal() {
    const basePrice = parseFloat(document.getElementById('base_price').value) || 0;
    const additionalCharges = parseFloat(document.getElementById('additional_charges').value) || 0;
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    
    const total = basePrice + additionalCharges - discount;
    document.getElementById('total_amount').textContent = '₹' + total.toLocaleString();
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize select elements
    var selectElems = document.querySelectorAll('select');
    M.FormSelect.init(selectElems);
    
    // Initialize character counter for textareas
    var textareaElems = document.querySelectorAll('textarea');
    M.CharacterCounter.init(textareaElems);
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('event_date').setAttribute('min', today);
    
    // Add event listeners for price calculation
    document.getElementById('additional_charges').addEventListener('input', calculateTotal);
    document.getElementById('discount').addEventListener('input', calculateTotal);
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const requiredFields = form.querySelectorAll('input[required], select[required], textarea[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('invalid');
                M.toast({html: 'Please fill in all required fields', classes: 'red'});
            } else {
                field.classList.remove('invalid');
                field.classList.add('valid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}