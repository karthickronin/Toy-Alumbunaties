{% extends 'crm/base.html' %}

{% block title %}CRM Dashboard{% endblock %}

{% block content %}
<!-- Key Metrics Row -->
<div class="row">
    <div class="col s12 m6 l3">
        <div class="metric-card customers">
            <i class="material-icons metric-icon">people</i>
            <div class="metric-value">{{ total_customers|default:0 }}</div>
            <div class="metric-label">Total Customers</div>
        </div>
    </div>
    <div class="col s12 m6 l3">
        <div class="metric-card leads">
            <i class="material-icons metric-icon">person_add</i>
            <div class="metric-value">{{ new_leads|default:0 }}</div>
            <div class="metric-label">New Leads</div>
        </div>
    </div>
    <div class="col s12 m6 l3">
        <div class="metric-card bookings">
            <i class="material-icons metric-icon">event</i>
            <div class="metric-value">{{ active_bookings|default:0 }}</div>
            <div class="metric-label">Active Bookings</div>
        </div>
    </div>
    <div class="col s12 m6 l3">
        <div class="metric-card revenue">
            <i class="material-icons metric-icon">attach_money</i>
            <div class="metric-value">₹{{ monthly_revenue|floatformat:0|default:0 }}</div>
            <div class="metric-label">Monthly Revenue</div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row">
    <div class="col s12 l6">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">pie_chart</i>Lead Sources
                </span>
                <div class="chart-container">
                    <canvas id="leadSourceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col s12 l6">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">bar_chart</i>Booking Status
                </span>
                <div class="chart-container">
                    <canvas id="bookingStatusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Tables Row -->
<div class="row">
    <!-- Recent Customers -->
    <div class="col s12 l4">
        <div class="card">
            <div class="card-content">
                <div class="row valign-wrapper" style="margin-bottom: 16px;">
                    <div class="col s8">
                        <span class="card-title">
                            <i class="material-icons left">people</i>Recent Customers
                        </span>
                    </div>
                    <div class="col s4 right-align">
                        <a href="{% url 'crm:customer_list' %}" class="btn-flat primary-text">View All</a>
                    </div>
                </div>
                
                {% if recent_customers %}
                    <div class="collection">
                        {% for customer in recent_customers %}
                        <a href="{% url 'crm:customer_detail' customer.id %}" class="collection-item avatar">
                            <div class="avatar-sm">
                                {{ customer.first_name.0|upper }}{{ customer.last_name.0|upper }}
                            </div>
                            <span class="title">{{ customer.full_name }}</span>
                            <p>{{ customer.email }}<br>
                               <span class="status-badge status-{{ customer.status }}">{{ customer.get_status_display }}</span>
                            </p>
                            <span class="secondary-content">
                                <i class="material-icons grey-text">chevron_right</i>
                            </span>
                        </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="material-icons">people_outline</i>
                        <h6>No customers yet</h6>
                        <p>Start by adding your first customer</p>
                        <a href="{% url 'crm:customer_create' %}" class="btn primary-color">
                            <i class="material-icons left">add</i>Add Customer
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Upcoming Events -->
    <div class="col s12 l4">
        <div class="card">
            <div class="card-content">
                <div class="row valign-wrapper" style="margin-bottom: 16px;">
                    <div class="col s8">
                        <span class="card-title">
                            <i class="material-icons left">event</i>Upcoming Events
                        </span>
                    </div>
                    <div class="col s4 right-align">
                        <a href="{% url 'crm:booking_list' %}" class="btn-flat primary-text">View All</a>
                    </div>
                </div>
                
                {% if upcoming_events %}
                    <div class="collection">
                        {% for booking in upcoming_events %}
                        {% if booking.id %}
                        <a href="{% url 'crm:booking_detail' booking.id %}" class="collection-item">
                            <div class="row valign-wrapper" style="margin-bottom: 0;">
                                <div class="col s8">
                                    <span class="title">{{ booking.customer.full_name }}</span>
                                    <p>{{ booking.get_event_type_display }} - {{ booking.get_package_display|title }}</p>
                                </div>
                                <div class="col s4 right-align">
                                    <strong>{{ booking.event_date|date:"M d" }}</strong><br>
                                    <small class="grey-text">₹{{ booking.total_amount|floatformat:0 }}</small>
                                </div>
                            </div>
                        </a>
                        {% else %}
                        <div class="collection-item">
                            <div class="row valign-wrapper" style="margin-bottom: 0;">
                                <div class="col s8">
                                    <span class="title">{{ booking.customer.full_name|default:"Unknown Customer" }}</span>
                                    <p>{{ booking.get_event_type_display|default:"Event" }} - {{ booking.get_package_display|title|default:"Package" }}</p>
                                </div>
                                <div class="col s4 right-align">
                                    <strong>{{ booking.event_date|date:"M d"|default:"TBD" }}</strong><br>
                                    <small class="grey-text">₹{{ booking.total_amount|floatformat:0|default:0 }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="material-icons">event_available</i>
                        <h6>No upcoming events</h6>
                        <p>No events scheduled</p>
                        <a href="{% url 'crm:booking_create' %}" class="btn primary-color">
                            <i class="material-icons left">add</i>New Booking
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Pending Tasks -->
    <div class="col s12 l4">
        <div class="card">
            <div class="card-content">
                <div class="row valign-wrapper" style="margin-bottom: 16px;">
                    <div class="col s8">
                        <span class="card-title">
                            <i class="material-icons left">assignment</i>Pending Tasks
                        </span>
                    </div>
                    <div class="col s4 right-align">
                        <a href="{% url 'crm:task_list' %}" class="btn-flat primary-text">View All</a>
                    </div>
                </div>
                
                {% if pending_tasks %}
                    <div class="collection">
                        {% for task in pending_tasks %}
                        <div class="collection-item">
                            <div class="row valign-wrapper" style="margin-bottom: 0;">
                                <div class="col s8">
                                    <span class="title">{{ task.title }}</span>
                                    <p>
                                        {% if task.customer %}{{ task.customer.full_name }}{% endif %}
                                    </p>
                                </div>
                                <div class="col s4 right-align">
                                    <i class="material-icons priority-{{ task.priority }} tiny">flag</i>
                                    <span class="priority-{{ task.priority }}">{{ task.get_priority_display }}</span><br>
                                    <small class="grey-text">{{ task.due_date|date:"M d" }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="material-icons">assignment_turned_in</i>
                        <h6>No pending tasks</h6>
                        <p>All caught up!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col s12">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">flash_on</i>Quick Actions
                </span>
                <div class="row">
                    <div class="col s12 m6 l3">
                        <a href="{% url 'crm:customer_create' %}" class="btn-large primary-color waves-effect waves-light" style="width: 100%;">
                            <i class="material-icons left">person_add</i>Add Customer
                        </a>
                    </div>
                    <div class="col s12 m6 l3">
                        <a href="{% url 'crm:booking_create' %}" class="btn-large green waves-effect waves-light" style="width: 100%;">
                            <i class="material-icons left">event_available</i>New Booking
                        </a>
                    </div>
                    <div class="col s12 m6 l3">
                        <a href="{% url 'crm:reports' %}" class="btn-large blue waves-effect waves-light" style="width: 100%;">
                            <i class="material-icons left">analytics</i>View Reports
                        </a>
                    </div>
                    <div class="col s12 m6 l3">
                        <a href="/admin/" class="btn-large grey waves-effect waves-light" style="width: 100%;" target="_blank">
                            <i class="material-icons left">settings</i>Admin Panel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Material Design Colors
const materialColors = [
    '#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', 
    '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50',
    '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'
];

// Lead Sources Chart
const leadSourceCtx = document.getElementById('leadSourceChart');
if (leadSourceCtx) {
    const leadSourceData = {
        labels: [
            {% for source in lead_sources %}
                '{{ source.lead_source|title }}'{% if not forloop.last %},{% endif %}
            {% empty %}
                'No Data'
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for source in lead_sources %}
                    {{ source.count }}{% if not forloop.last %},{% endif %}
                {% empty %}
                    0
                {% endfor %}
            ],
            backgroundColor: materialColors.slice(0, {{ lead_sources|length|default:1 }}),
            borderWidth: 0
        }]
    };
    
    new Chart(leadSourceCtx, {
        type: 'doughnut',
        data: leadSourceData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            },
            cutout: '60%'
        }
    });
}

// Booking Status Chart
const bookingStatusCtx = document.getElementById('bookingStatusChart');
if (bookingStatusCtx) {
    const bookingStatusData = {
        labels: [
            {% for status in booking_status %}
                '{{ status.status|title }}'{% if not forloop.last %},{% endif %}
            {% empty %}
                'No Data'
            {% endfor %}
        ],
        datasets: [{
            label: 'Bookings',
            data: [
                {% for status in booking_status %}
                    {{ status.count }}{% if not forloop.last %},{% endif %}
                {% empty %}
                    0
                {% endfor %}
            ],
            backgroundColor: '#4ecdc4',
            borderColor: '#ff6b35',
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
        }]
    };
    
    new Chart(bookingStatusCtx, {
        type: 'bar',
        data: bookingStatusData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#e0e0e0'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}
</script>
{% endblock %}