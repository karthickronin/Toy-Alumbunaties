{% extends 'crm/base.html' %}

{% block title %}Reports{% endblock %}
{% block page_title %}Business Reports{% endblock %}
{% block page_subtitle %}Analytics and insights for your business{% endblock %}

{% block header_actions %}
<a class="dropdown-trigger btn primary-color waves-effect waves-light" href="#!" data-target="export-dropdown">
    <i class="material-icons left">file_download</i>Export Reports<i class="material-icons right">arrow_drop_down</i>
</a>
<ul id="export-dropdown" class="dropdown-content">
    <li><a href="#!"><i class="material-icons">picture_as_pdf</i>Export PDF</a></li>
    <li><a href="#!"><i class="material-icons">table_chart</i>Export Excel</a></li>
    <li><a href="#!"><i class="material-icons">image</i>Export Images</a></li>
</ul>
{% endblock %}

{% block content %}
<!-- Date Range Selector -->
<div class="card">
    <div class="card-content">
        <span class="card-title">
            <i class="material-icons left">date_range</i>Report Period
        </span>
        <div class="row">
            <div class="input-field col s12 m3">
                <input type="date" id="start_date" value="{{ start_date|date:'Y-m-d' }}">
                <label for="start_date">Start Date</label>
            </div>
            <div class="input-field col s12 m3">
                <input type="date" id="end_date" value="{{ end_date|date:'Y-m-d' }}">
                <label for="end_date">End Date</label>
            </div>
            <div class="col s12 m3">
                <button class="btn primary-color waves-effect waves-light" style="margin-top: 20px;" onclick="updateReports()">
                    <i class="material-icons left">refresh</i>Update Reports
                </button>
            </div>
            <div class="col s12 m3">
                <div class="right-align" style="margin-top: 20px;">
                    <span class="chip">
                        <i class="material-icons left tiny">info</i>
                        {{ start_date }} to {{ end_date }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Overview -->
<div class="row">
    <div class="col s12 m6 l3">
        <div class="metric-card customers">
            <i class="material-icons metric-icon">people</i>
            <div class="metric-value">{{ customer_growth|length|default:0 }}</div>
            <div class="metric-label">New Customers</div>
        </div>
    </div>
    <div class="col s12 m6 l3">
        <div class="metric-card revenue">
            <i class="material-icons metric-icon">attach_money</i>
            <div class="metric-value">
                ₹{% for trend in booking_trends %}{{ trend.total_revenue|add:0 }}{% endfor %}
            </div>
            <div class="metric-label">Total Revenue</div>
        </div>
    </div>
    <div class="col s12 m6 l3">
        <div class="metric-card bookings">
            <i class="material-icons metric-icon">event</i>
            <div class="metric-value">
                {% for trend in booking_trends %}{{ trend.booking_count|add:0 }}{% endfor %}
            </div>
            <div class="metric-label">Total Bookings</div>
        </div>
    </div>
    <div class="col s12 m6 l3">
        <div class="metric-card leads">
            <i class="material-icons metric-icon">trending_up</i>
            <div class="metric-value">
                {% if lead_performance %}
                    {{ lead_performance.0.conversion_rate|floatformat:1 }}%
                {% else %}0%{% endif %}
            </div>
            <div class="metric-label">Conversion Rate</div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row">
    <!-- Customer Growth Chart -->
    <div class="col s12 l6">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">trending_up</i>Customer Growth
                </span>
                <div class="chart-container">
                    <canvas id="customerGrowthChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Revenue by Package Chart -->
    <div class="col s12 l6">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">pie_chart</i>Revenue by Package
                </span>
                <div class="chart-container">
                    <canvas id="revenueByPackageChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Lead Performance Chart -->
    <div class="col s12 l6">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">source</i>Lead Source Performance
                </span>
                <div class="chart-container">
                    <canvas id="leadPerformanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Booking Trends Chart -->
    <div class="col s12 l6">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">show_chart</i>Booking Trends
                </span>
                <div class="chart-container">
                    <canvas id="bookingTrendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Tables -->
<div class="row">
    <!-- Revenue by Package Table -->
    <div class="col s12 l6">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">table_chart</i>Package Performance
                </span>
                {% if revenue_by_package %}
                    <table class="striped">
                        <thead>
                            <tr>
                                <th>Package</th>
                                <th>Bookings</th>
                                <th>Revenue</th>
                                <th>Avg. Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for package in revenue_by_package %}
                            <tr>
                                <td>
                                    <span class="chip 
                                        {% if package.package == 'silver' %}grey
                                        {% elif package.package == 'gold' %}amber
                                        {% elif package.package == 'diamond' %}blue
                                        {% endif %} white-text">
                                        {{ package.package|title }}
                                    </span>
                                </td>
                                <td>{{ package.booking_count }}</td>
                                <td><strong>₹{{ package.total_revenue|floatformat:0 }}</strong></td>
                                <td>₹{% widthratio package.total_revenue 1 package.booking_count %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <i class="material-icons">table_chart</i>
                        <h6>No package data available</h6>
                        <p>Data will appear once you have bookings</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Lead Source Performance Table -->
    <div class="col s12 l6">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">source</i>Lead Sources
                </span>
                {% if lead_performance %}
                    <table class="striped">
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Customers</th>
                                <th>Conversion</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for source in lead_performance %}
                            <tr>
                                <td>{{ source.lead_source|title }}</td>
                                <td>{{ source.customer_count }}</td>
                                <td>{{ source.conversion_rate|floatformat:1 }}%</td>
                                <td>
                                    <div class="progress">
                                        <div class="determinate primary-color" style="width: {{ source.conversion_rate }}%"></div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <i class="material-icons">source</i>
                        <h6>No lead source data available</h6>
                        <p>Data will appear once you have customers</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row">
    <div class="col s12">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">insights</i>Key Insights
                </span>
                <div class="row">
                    <div class="col s12 m6 l3">
                        <div class="card-panel center-align blue lighten-5">
                            <i class="material-icons large blue-text">star</i>
                            <h6>Best Package</h6>
                            <p>
                                {% if revenue_by_package %}
                                    <strong>{{ revenue_by_package.0.package|title }}</strong><br>
                                    ₹{{ revenue_by_package.0.total_revenue|floatformat:0 }} revenue
                                {% else %}
                                    No data yet
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="col s12 m6 l3">
                        <div class="card-panel center-align green lighten-5">
                            <i class="material-icons large green-text">trending_up</i>
                            <h6>Top Lead Source</h6>
                            <p>
                                {% if lead_performance %}
                                    <strong>{{ lead_performance.0.lead_source|title }}</strong><br>
                                    {{ lead_performance.0.customer_count }} customers
                                {% else %}
                                    No data yet
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="col s12 m6 l3">
                        <div class="card-panel center-align orange lighten-5">
                            <i class="material-icons large orange-text">event</i>
                            <h6>Monthly Average</h6>
                            <p>
                                {% if booking_trends %}
                                    <strong>{{ booking_trends|length }} bookings</strong><br>
                                    per month
                                {% else %}
                                    No data yet
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="col s12 m6 l3">
                        <div class="card-panel center-align purple lighten-5">
                            <i class="material-icons large purple-text">attach_money</i>
                            <h6>Avg. Booking Value</h6>
                            <p>
                                {% if revenue_by_package %}
                                    <strong>₹{% for package in revenue_by_package %}{% widthratio package.total_revenue 1 package.booking_count %}{% endfor %}</strong><br>
                                    per booking
                                {% else %}
                                    No data yet
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Material Design Colors
const materialColors = {
    primary: '#ff6b35',
    secondary: '#4ecdc4',
    blue: '#2196f3',
    green: '#4caf50',
    orange: '#ff9800',
    purple: '#9c27b0',
    red: '#f44336',
    amber: '#ffc107',
    grey: '#9e9e9e'
};

// Customer Growth Chart
const customerGrowthCtx = document.getElementById('customerGrowthChart');
if (customerGrowthCtx) {
    new Chart(customerGrowthCtx, {
        type: 'line',
        data: {
            labels: [
                {% for growth in customer_growth %}
                    '{{ growth.month }}'{% if not forloop.last %},{% endif %}
                {% empty %}
                    'No Data'
                {% endfor %}
            ],
            datasets: [{
                label: 'New Customers',
                data: [
                    {% for growth in customer_growth %}
                        {{ growth.count }}{% if not forloop.last %},{% endif %}
                    {% empty %}
                        0
                    {% endfor %}
                ],
                borderColor: materialColors.primary,
                backgroundColor: materialColors.primary + '20',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Revenue by Package Chart
const revenueByPackageCtx = document.getElementById('revenueByPackageChart');
if (revenueByPackageCtx) {
    new Chart(revenueByPackageCtx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for package in revenue_by_package %}
                    '{{ package.package|title }}'{% if not forloop.last %},{% endif %}
                {% empty %}
                    'No Data'
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for package in revenue_by_package %}
                        {{ package.total_revenue }}{% if not forloop.last %},{% endif %}
                    {% empty %}
                        0
                    {% endfor %}
                ],
                backgroundColor: [materialColors.grey, materialColors.amber, materialColors.blue],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Lead Performance Chart
const leadPerformanceCtx = document.getElementById('leadPerformanceChart');
if (leadPerformanceCtx) {
    new Chart(leadPerformanceCtx, {
        type: 'bar',
        data: {
            labels: [
                {% for source in lead_performance %}
                    '{{ source.lead_source|title }}'{% if not forloop.last %},{% endif %}
                {% empty %}
                    'No Data'
                {% endfor %}
            ],
            datasets: [{
                label: 'Customers',
                data: [
                    {% for source in lead_performance %}
                        {{ source.customer_count }}{% if not forloop.last %},{% endif %}
                    {% empty %}
                        0
                    {% endfor %}
                ],
                backgroundColor: materialColors.secondary,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Booking Trends Chart
const bookingTrendsCtx = document.getElementById('bookingTrendsChart');
if (bookingTrendsCtx) {
    new Chart(bookingTrendsCtx, {
        type: 'line',
        data: {
            labels: [
                {% for trend in booking_trends %}
                    '{{ trend.month }}'{% if not forloop.last %},{% endif %}
                {% empty %}
                    'No Data'
                {% endfor %}
            ],
            datasets: [{
                label: 'Bookings',
                data: [
                    {% for trend in booking_trends %}
                        {{ trend.booking_count }}{% if not forloop.last %},{% endif %}
                    {% empty %}
                        0
                    {% endfor %}
                ],
                borderColor: materialColors.green,
                backgroundColor: materialColors.green + '20',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateReports() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    
    if (startDate && endDate) {
        // This would typically make an AJAX call to update the reports
        M.toast({html: 'Reports updated for ' + startDate + ' to ' + endDate, classes: 'green'});
        // For now, just reload the page with new parameters
        window.location.href = `?start_date=${startDate}&end_date=${endDate}`;
    } else {
        M.toast({html: 'Please select both start and end dates', classes: 'red'});
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize dropdowns
    var dropdownElems = document.querySelectorAll('.dropdown-trigger');
    M.Dropdown.init(dropdownElems);
    
    // Set default dates if not set
    const today = new Date();
    const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
    
    if (!document.getElementById('start_date').value) {
        document.getElementById('start_date').value = threeMonthsAgo.toISOString().split('T')[0];
    }
    if (!document.getElementById('end_date').value) {
        document.getElementById('end_date').value = today.toISOString().split('T')[0];
    }
});
</script>
{% endblock %}