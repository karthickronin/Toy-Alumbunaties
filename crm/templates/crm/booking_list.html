{% extends 'crm/base.html' %}

{% block title %}Bookings{% endblock %}
{% block page_title %}Event Bookings{% endblock %}
{% block page_subtitle %}Manage your event bookings{% endblock %}

{% block header_actions %}
<a href="{% url 'crm:booking_create' %}" class="btn primary-color waves-effect waves-light">
    <i class="material-icons left">event_available</i>New Booking
</a>
{% endblock %}

{% block content %}
<!-- Search and Filters -->
<div class="card">
    <div class="card-content">
        <span class="card-title">
            <i class="material-icons left">filter_list</i>Search & Filter
        </span>
        <form method="get">
            <div class="row">
                <div class="input-field col s12 m3">
                    <i class="material-icons prefix">search</i>
                    <input type="text" name="search" id="search" value="{{ search_query|default:'' }}">
                    <label for="search">Search bookings...</label>
                </div>
                <div class="input-field col s12 m2">
                    <select name="status">
                        <option value="">All Status</option>
                        {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                    <label>Status</label>
                </div>
                <div class="input-field col s12 m2">
                    <input type="date" name="date_from" value="{{ date_from|default:'' }}">
                    <label for="date_from">From Date</label>
                </div>
                <div class="input-field col s12 m2">
                    <input type="date" name="date_to" value="{{ date_to|default:'' }}">
                    <label for="date_to">To Date</label>
                </div>
                <div class="col s12 m3">
                    <button type="submit" class="btn primary-color waves-effect waves-light" style="margin-top: 20px; width: 100%;">
                        <i class="material-icons left">search</i>Search
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Booking List -->
<div class="card">
    <div class="card-content">
        <div class="row valign-wrapper" style="margin-bottom: 16px;">
            <div class="col s8">
                <span class="card-title">
                    <i class="material-icons left">event</i>Booking List
                    <span class="new badge primary-color" data-badge-caption="total">{{ bookings.paginator.count|default:0 }}</span>
                </span>
            </div>
            <div class="col s4 right-align">
                <a class="dropdown-trigger btn-flat" href="#!" data-target="export-dropdown">
                    <i class="material-icons left">file_download</i>Export<i class="material-icons right">arrow_drop_down</i>
                </a>
                <ul id="export-dropdown" class="dropdown-content">
                    <li><a href="#!"><i class="material-icons">picture_as_pdf</i>Export PDF</a></li>
                    <li><a href="#!"><i class="material-icons">table_chart</i>Export Excel</a></li>
                </ul>
            </div>
        </div>
        
        {% if bookings %}
            <div class="data-table">
                <table class="striped responsive-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Event Date</th>
                            <th>Event Type</th>
                            <th>Package</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr>
                            <td>
                                <div class="row valign-wrapper" style="margin-bottom: 0;">
                                    <div class="col s3">
                                        <div class="avatar-sm">
                                            {{ booking.customer.first_name.0|upper }}{{ booking.customer.last_name.0|upper }}
                                        </div>
                                    </div>
                                    <div class="col s9">
                                        <strong>{{ booking.customer.full_name }}</strong>
                                        <br><small class="grey-text">{{ booking.customer.phone }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <strong>{{ booking.event_date|date:"M d, Y" }}</strong>
                                <br><small class="grey-text">{{ booking.event_time|time:"g:i A" }}</small>
                            </td>
                            <td>
                                <span class="chip">{{ booking.get_event_type_display }}</span>
                            </td>
                            <td>
                                <span class="chip 
                                    {% if booking.package == 'silver' %}grey
                                    {% elif booking.package == 'gold' %}amber
                                    {% elif booking.package == 'diamond' %}blue
                                    {% endif %} white-text">
                                    {{ booking.get_package_display }}
                                </span>
                            </td>
                            <td>
                                <strong>₹{{ booking.total_amount|floatformat:0 }}</strong>
                                {% if booking.advance_paid > 0 %}
                                    <br><small class="green-text">Advance: ₹{{ booking.advance_paid|floatformat:0 }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-badge status-{{ booking.status }}">
                                    {{ booking.get_status_display }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge 
                                    {% if booking.payment_status == 'completed' %}status-completed
                                    {% elif booking.payment_status == 'partial' %}status-quoted
                                    {% else %}status-inquiry
                                    {% endif %}">
                                    {{ booking.get_payment_status_display }}
                                </span>
                            </td>
                            <td>
                                <a href="{% url 'crm:booking_detail' booking.id %}" class="btn-small primary-color waves-effect waves-light" data-tooltip="View Details">
                                    <i class="material-icons">visibility</i>
                                </a>
                                <a href="#!" class="btn-small green waves-effect waves-light" data-tooltip="Call Customer">
                                    <i class="material-icons">phone</i>
                                </a>
                                <a href="#!" class="btn-small blue waves-effect waves-light" data-tooltip="Send Message">
                                    <i class="material-icons">message</i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="material-icons">event_available</i>
                <h5>No bookings found</h5>
                <p>
                    {% if search_query %}
                        Try adjusting your search criteria
                    {% else %}
                        Start by creating your first booking
                    {% endif %}
                </p>
                <a href="{% url 'crm:booking_create' %}" class="btn-large primary-color waves-effect waves-light">
                    <i class="material-icons left">event_available</i>New Booking
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Pagination -->
{% if bookings.has_other_pages %}
<div class="center-align">
    <ul class="pagination">
        {% if bookings.has_previous %}
            <li class="waves-effect">
                <a href="?page={{ bookings.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                    <i class="material-icons">chevron_left</i>
                </a>
            </li>
        {% endif %}
        
        {% for num in bookings.paginator.page_range %}
            {% if bookings.number == num %}
                <li class="active primary-color">
                    <span>{{ num }}</span>
                </li>
            {% elif num > bookings.number|add:'-3' and num < bookings.number|add:'3' %}
                <li class="waves-effect">
                    <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if bookings.has_next %}
            <li class="waves-effect">
                <a href="?page={{ bookings.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                    <i class="material-icons">chevron_right</i>
                </a>
            </li>
        {% endif %}
    </ul>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize dropdowns
    var dropdownElems = document.querySelectorAll('.dropdown-trigger');
    M.Dropdown.init(dropdownElems);
    
    // Initialize tooltips
    var tooltipElems = document.querySelectorAll('[data-tooltip]');
    M.Tooltip.init(tooltipElems);
    
    // Initialize select elements
    var selectElems = document.querySelectorAll('select');
    M.FormSelect.init(selectElems);
    
    // Initialize date inputs
    var dateElems = document.querySelectorAll('input[type="date"]');
    dateElems.forEach(function(elem) {
        elem.addEventListener('change', function() {
            if (this.value) {
                this.classList.add('valid');
            }
        });
    });
});
</script>
{% endblock %}